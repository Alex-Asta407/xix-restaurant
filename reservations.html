<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#1a1a1a">
    <title>Reservations - XIX Restaurant</title>
    <link rel="icon" type="image/x-icon" href="photos/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="photos/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="photos/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="photos/apple-icon-180x180.png">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="navigation.css">
    <link rel="stylesheet" href="reservations.css">
    <link rel="stylesheet" href="footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Gilda+Display&family=Noto+Sans:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/xix">
                    <h1>XIX</h1>
                </a>
            </div>
            <ul class="nav-menu">
                <!-- <li><a href="/xix">Home</a></li> -->
                <li><a href="/menu">Menu</a></li>
                <li><a href="/events">Events</a></li>
                <li><a href="/reservations" class="active">Reservations</a></li>
                <li><a href="/xix/catering">Catering</a></li>
                <li><a href="/mirror">Mirror</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Reservations Hero Section -->
    <section class="reservations-hero">
        <div class="container">
            <div class="reservations-hero-content">
                <h1 class="reservations-title">Reserve Your Table</h1>
                <p class="reservations-subtitle">Experience the vibrant atmosphere at XIX. Secure your spot now and
                    indulge in our exquisite menu.</p>
            </div>
        </div>
    </section>

    <!-- Reservation Form Section -->
    <section class="reservation-form-section">
        <div class="container">
            <div class="reservation-form-container">
                <form id="reservationForm" class="reservation-form" method="post" action="/api/send-reservation-email">
                    <div class="form-header">
                        <h2>Make a Reservation</h2>
                        <p>Please fill out the form below to reserve your table</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="name" required>
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" name="email" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number *</label>
                            <input type="tel" id="phone" name="phone" required>
                            <small style="display: block; margin-top: 5px; color: #666;">Required even if all tables are
                                booked - we'll contact you if availability opens up</small>
                        </div>

                        <div class="form-group">
                            <label for="guests">Number of Guests *</label>
                            <select id="guests" name="guests" required>
                                <option value="">Select Guests</option>
                                <option value="1">1 Guest</option>
                                <option value="2">2 Guests</option>
                                <option value="3">3 Guests</option>
                                <option value="4">4 Guests</option>
                                <option value="5">5 Guests</option>
                                <option value="6">6 Guests</option>
                                <option value="7">7 Guests</option>
                                <option value="8">8 Guests</option>
                                <option value="9">9 Guests</option>
                                <option value="10">10 Guests</option>
                                <option value="11">11 Guests</option>
                                <option value="12">12 Guests</option>
                            </select>
                            <div id="tableAvailabilityInfo"
                                style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label for="date">Preferred Date *</label>
                            <input type="date" id="date" name="date" required min="">
                        </div>

                        <div class="form-group">
                            <label for="time">Preferred Time *</label>
                            <select id="time" name="time" required>
                                <option value="">Select Time</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="09:30">9:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="10:30">10:30 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="11:30">11:30 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="12:30">12:30 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="13:30">1:30 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="14:30">2:30 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="15:30">3:30 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="16:30">4:30 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="17:30">5:30 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="18:30">6:30 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="19:30">7:30 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="20:30">8:30 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="21:30">9:30 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="22:30">10:30 PM</option>
                                <option value="23:00">11:00 PM</option>
                                <option value="23:30">11:30 PM</option>
                                <option value="00:00">12:00 AM</option>
                                <option value="00:30">12:30 AM</option>
                                <option value="01:00">1:00 AM</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="occasion">Special Occasion</label>
                            <select id="occasion" name="occasion">
                                <option value="">None</option>
                                <option value="birthday">Birthday</option>
                                <option value="anniversary">Anniversary</option>
                                <option value="business">Business Dinner</option>
                                <option value="date">Date Night</option>
                                <option value="celebration">Celebration</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="special-requests">Special Requests or Dietary Requirements</label>
                        <textarea id="special-requests" name="special-requests" rows="4"
                            placeholder="Please let us know about any allergies, dietary restrictions, or special requests..."></textarea>
                    </div>


                    <button type="submit" class="submit-button">
                        <i class="fas fa-calendar-check"></i>
                        Reserve Table
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- Restaurant Info Section -->
    <section class="restaurant-info">
        <div class="container">
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3>Opening Hours</h3>
                    <div class="info-details">
                        <p><strong>Monday - Sunday:</strong> 9:00 AM - 1:00 AM</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Group Bookings</h3>
                    <div class="info-details">
                        <p>For parties of 10 or more, please call us directly to discuss availability and special
                            arrangements.</p>
                        <p><strong>Phone:</strong> +44 7796 817690</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <h3>Dining Experience</h3>
                    <div class="info-details">
                        <p>Average dining time is 2-3 hours. We recommend arriving 15 minutes early for your
                            reservation.</p>
                        <p>Smart casual dress code applies.</p>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h3>Payment & Policies</h3>
                    <div class="info-details">
                        <p>We accept all major credit cards. A 12.5% service charge is added to parties of 8 or more.
                        </p>
                        <p>Cancellations must be made 24 hours in advance.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Section -->
    <section class="contact-section">
        <div class="container">
            <div class="contact-content fade-in">
                <div class="contact-left">
                    <h2>Get in Touch</h2>
                    <p>Have questions about your reservation or need assistance? We're here to help!</p>

                    <div class="contact-details">
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <h4>Phone</h4>
                                <p>+44 7796 817690</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <h4>Email</h4>
                                <p>reservations@xixlondon.com</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <h4>Address</h4>
                                <p>123 King's Road<br>London SW3 4RD</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="contact-right">
                    <div class="map-container">
                        <iframe
                            src="https://maps.google.com/maps?q=369+High+St,+Greater,+London+E15+4QZ,+United+Kingdom&hl=en&z=14&output=embed"
                            width="100%" height="100%" style="border:0; border-radius: 10px;" allowfullscreen=""
                            loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="confirmation-content">
                <i class="fas fa-check-circle"></i>
                <h2>Reservation Confirmed!</h2>
                <div id="reservationDetails"></div>
                <p>You will receive a confirmation email shortly.</p>
                <button id="addToCalendar" class="calendar-button">Add to Google Calendar</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>XIX</h2>
                    <p>Where Flavor Meets Elegance</p>
                </div>
                <div class="footer-links">
                    <!-- <a href="index.html">Home</a> -->
                    <a href="menu.html">Menu</a>
                    <a href="events.html">Events</a>
                    <a href="reservations.html">Reservations</a>
                    <a href="mirror.html">Mirror</a>
                </div>
                <div class="footer-social">
                    <a href="https://www.instagram.com/xix_nineteen/" target="_blank" class="social-link">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://www.facebook.com/xixfood?mibextid=LQQJ4d&rdid=PWIlySw1n2GjmE0E&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2FGk1tdQBeAJDy4VQC%2F%3Fmibextid%3DLQQJ4d#"
                        target="_blank" class="social-link">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://www.tiktok.com/@xix_nineteen" target="_blank" class="social-link">
                        <i class="fab fa-tiktok"></i>
                    </a>
                    <a href="https://www.ubereats.com/store/xix-nineteen-ukrainian-kitchen/Qb_tE0nYX0G5Xol7_t3LZA?diningMode=DELIVERY"
                        target="_blank" class="social-link">
                        <i class="fas fa-utensils"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="offline.js"></script>

    <script>
        // Enhanced mobile navigation for reservations page
        document.addEventListener('DOMContentLoaded', function () {
            // Ensure navigation logo works on mobile
            const navLogo = document.querySelector('.nav-logo a');
            if (navLogo) {
                // Add touch event listeners for better mobile responsiveness
                navLogo.addEventListener('touchstart', function (e) {
                    // Don't prevent default to allow navigation
                });

                navLogo.addEventListener('touchend', function (e) {
                    // Allow natural click behavior
                });

                // Ensure click events work
                navLogo.addEventListener('click', function (e) {
                    // Allow navigation to proceed
                });
            }
        });

        // Direct form submission handler for XIX reservations
        document.addEventListener('DOMContentLoaded', function () {
            // Set minimum date to today
            const dateInput = document.getElementById('date');
            const timeSelect = document.getElementById('time');

            if (dateInput) {
                // Get today's date in local timezone (YYYY-MM-DD format)
                // Use toLocaleDateString('en-CA') which returns YYYY-MM-DD in local timezone
                const today = new Date().toLocaleDateString('en-CA');
                dateInput.min = today;

                // Filter initial time options if today is selected
                function filterTimeOptions() {
                    if (!timeSelect) return;

                    const selectedDate = dateInput.value;
                    const isToday = selectedDate === today;

                    if (isToday) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const currentMinute = now.getMinutes();
                        const currentTimeInMinutes = currentHour * 60 + currentMinute;

                        // Filter out past times (at least 30 minutes in the future)
                        Array.from(timeSelect.options).forEach(option => {
                            if (option.value && option.value !== '') {
                                const [h, m] = option.value.split(':');
                                let timeHour = parseInt(h, 10);
                                const timeMinute = parseInt(m, 10);

                                // Handle midnight times (00:00, 00:30, 01:00) - these are next day
                                // So if it's today and time is 00:00-01:00, it's actually tomorrow, so show it
                                if (timeHour === 0 || timeHour === 1) {
                                    // These times are for the next day, so always show them
                                    option.disabled = false;
                                    option.style.display = '';
                                    return;
                                }

                                const timeInMinutes = timeHour * 60 + timeMinute;

                                if (timeInMinutes < (currentTimeInMinutes + 30)) {
                                    option.disabled = true;
                                    option.style.display = 'none';
                                } else {
                                    option.disabled = false;
                                    option.style.display = '';
                                }
                            }
                        });
                    } else {
                        // Enable all options for future dates
                        Array.from(timeSelect.options).forEach(option => {
                            option.disabled = false;
                            option.style.display = '';
                        });
                    }
                }

                // Filter times on page load if date is already set
                if (dateInput.value) {
                    filterTimeOptions();
                }

                // Debounce availability check to reduce API calls
                let availabilityCheckTimeout;
                dateInput.addEventListener('change', function () {
                    clearTimeout(availabilityCheckTimeout);
                    // Wait 500ms after user stops changing date before checking
                    availabilityCheckTimeout = setTimeout(() => {
                        if (this.value) {
                            checkAvailableTimes(this.value, 'xix');
                            checkTableAvailability();
                        } else {
                            // If date is cleared, filter times based on today
                            filterTimeOptions();
                        }
                    }, 500);
                });
            }

            // Check table availability when guests, date, or time changes
            const guestsSelect = document.getElementById('guests');
            // timeSelect and dateInput already declared above in the form submission handler

            let tableAvailabilityTimeout;
            function checkTableAvailability() {
                const guests = guestsSelect?.value;
                const date = dateInput?.value;
                const time = timeSelect?.value;

                if (!guests || !date || !time) {
                    const infoDiv = document.getElementById('tableAvailabilityInfo');
                    if (infoDiv) {
                        infoDiv.style.display = 'none';
                    }
                    return;
                }

                clearTimeout(tableAvailabilityTimeout);
                tableAvailabilityTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/table-availability?date=${date}&time=${time}&guests=${guests}&venue=XIX`);
                        if (!response.ok) {
                            throw new Error('Failed to check table availability');
                        }

                        const data = await response.json();
                        displayTableAvailability(data);
                    } catch (error) {
                        console.error('Error checking table availability:', error);
                    }
                }, 300);
            }

            function displayTableAvailability(data) {
                const infoDiv = document.getElementById('tableAvailabilityInfo');
                if (!infoDiv) return;

                if (data.availabilityStatus === 'full') {
                    infoDiv.style.display = 'block';
                    infoDiv.style.backgroundColor = '#ffebee';
                    infoDiv.style.border = '1px solid #ffcdd2';
                    infoDiv.style.color = '#c62828';
                    infoDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>All tables are booked</strong><br>
                        ${data.message}
                    `;
                } else if (data.availabilityStatus === 'limited') {
                    infoDiv.style.display = 'block';
                    infoDiv.style.backgroundColor = '#fff3cd';
                    infoDiv.style.border = '1px solid #ffc107';
                    infoDiv.style.color = '#856404';
                    infoDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i> 
                        <strong>Limited availability</strong><br>
                        ${data.message}
                    `;
                } else {
                    infoDiv.style.display = 'block';
                    infoDiv.style.backgroundColor = '#e8f5e9';
                    infoDiv.style.border = '1px solid #81c784';
                    infoDiv.style.color = '#2e7d32';
                    infoDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <strong>Tables available</strong><br>
                        ${data.message}
                    `;
                }
            }

            // Add event listeners for table availability checking
            if (guestsSelect) {
                guestsSelect.addEventListener('change', checkTableAvailability);
            }
            if (timeSelect) {
                timeSelect.addEventListener('change', checkTableAvailability);
            }
            if (dateInput) {
                dateInput.addEventListener('change', checkTableAvailability);
            }

            const form = document.getElementById('reservationForm');
            if (form) {
                console.log('XIX: Found form, attaching direct handler');

                // Prevent multiple submissions
                let isSubmitting = false;

                form.addEventListener('submit', async function (e) {
                    console.log('XIX: Form submission intercepted directly!');
                    e.preventDefault();
                    e.stopPropagation();

                    // Prevent multiple submissions
                    if (isSubmitting) {
                        console.log('XIX: Form already submitting, ignoring duplicate submission');
                        return;
                    }
                    isSubmitting = true;

                    // Get submit button and show loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Processing...';
                    submitBtn.disabled = true;

                    // Get form data
                    const formData = new FormData(this);
                    const reservation = {
                        name: formData.get('name'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        date: formData.get('date'),
                        time: formData.get('time'),
                        guests: formData.get('guests'),
                        table: formData.get('table'),
                        occasion: formData.get('occasion'),
                        specialRequests: formData.get('special-requests'),
                        venue: 'xix', // Force XIX venue
                        eventType: formData.get('event-type'),
                        menuPreference: formData.get('menu-preference'),
                        entertainment: formData.get('entertainment')
                    };

                    console.log('XIX: Reservation data:', reservation);
                    console.log('XIX: Date from form:', reservation.date, '(should be YYYY-MM-DD format)');
                    
                    // CRITICAL: Ensure date is sent exactly as selected (no conversion)
                    // HTML5 date inputs return YYYY-MM-DD in user's local timezone, which is what we want
                    if (!reservation.date || !/^\d{4}-\d{2}-\d{2}$/.test(reservation.date)) {
                        console.error('⚠️ Date format invalid:', reservation.date);
                        alert('Invalid date format. Please select a date again.');
                        submitBtn.disabled = false;
                        return;
                    }

                    // Check if the selected time is still available
                    try {
                        const availabilityResponse = await fetch(`/api/available-times?date=${reservation.date}&venue=xix`);

                        if (!availabilityResponse.ok) {
                            throw new Error('Availability check failed');
                        }

                        const availabilityData = await availabilityResponse.json();

                        if (!availabilityData.availableTimes || !availabilityData.availableTimes.includes(reservation.time)) {
                            alert('Sorry, this time slot is no longer available. Please select another time.');
                            // Reset submission state
                            isSubmitting = false;
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking time availability:', error);
                        alert('Error checking time availability. Please try again.');
                        // Reset submission state
                        isSubmitting = false;
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        return;
                    }

                    try {
                        const response = await fetch('/api/send-reservation-email', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(reservation)
                        });

                        const result = await response.json();
                        console.log('XIX: Server response:', result);
                        console.log('XIX: Reservation data:', result.reservation);

                        if (response.ok) {
                            // Show success modal with reservation data
                            showConfirmationModal(result.reservation);
                            // Reset the form
                            form.reset();
                        } else {
                            // Show detailed error message
                            let errorMessage = result.error || 'Unknown error';
                            if (result.details && Array.isArray(result.details)) {
                                errorMessage = result.details.join('\n');
                            }
                            alert('Error: ' + errorMessage);
                        }
                    } catch (error) {
                        console.error('XIX: Error:', error);
                        alert('Error submitting reservation: ' + error.message);
                    } finally {
                        // Reset submission flag and button state
                        isSubmitting = false;
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });

        function showConfirmationModal(data) {
            console.log('showConfirmationModal called with data:', data);
            console.log('Data type:', typeof data);
            console.log('Data keys:', Object.keys(data || {}));

            // Remove any existing modal first
            const existingModal = document.getElementById('confirmationModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Force create new modal with timestamp
            const timestamp = Date.now();
            console.log('Creating modal with timestamp:', timestamp);

            let modal = document.createElement('div');
            modal.id = 'confirmationModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="success-icon">✓</div>
                    <h2>Reservation Confirmed!</h2>
                    <div id="reservationDetails"></div>
                    <p>You will receive a confirmation email shortly.</p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button id="addToCalendar" class="btn-primary">Add to Google Calendar</button>
                        <button id="backButton" class="btn-secondary" style="background: #8b7355; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; pointer-events: auto; z-index: 1001; position: relative;">Back</button>
                    </div>
                </div>
            `;

            // Add the modal to DOM
            document.body.appendChild(modal);
            console.log('Modal created with Back button:', modal.innerHTML);
            console.log('Back button element:', modal.querySelector('#backButton'));
            console.log('Back button visible:', modal.querySelector('#backButton') ? 'YES' : 'NO');

            // Populate details
            const details = document.getElementById('reservationDetails');
            console.log('Populating modal with data:', data);
            console.log('Name:', data.name, 'Email:', data.email, 'Phone:', data.phone);

            details.innerHTML = `
                <div class="reservation-details">
                    <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
                    <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
                    <p><strong>Date:</strong> ${data.date ? (() => {
                    const dateParts = data.date.split('-');
                    const dateYear = parseInt(dateParts[0], 10);
                    const dateMonth = parseInt(dateParts[1], 10) - 1;
                    const dateDay = parseInt(dateParts[2], 10);
                    const dateObj = new Date(dateYear, dateMonth, dateDay);
                    return dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                })() : 'N/A'}</p>
                    <p><strong>Time:</strong> ${data.time || 'N/A'}</p>
                    <p><strong>Guests:</strong> ${data.guests || 'N/A'}</p>
                    <p><strong>Table:</strong> ${data.table || 'Any Available'}</p>
                    ${data.eventType ? `<p><strong>Event Type:</strong> ${data.eventType}</p>` : ''}
                    ${data.menuPreference ? `<p><strong>Menu Preference:</strong> ${data.menuPreference}</p>` : ''}
                    ${data.entertainment ? `<p><strong>Entertainment:</strong> ${data.entertainment}</p>` : ''}
                </div>
            `;

            // Add Google Calendar functionality
            const addToCalendarBtn = document.getElementById('addToCalendar');
            if (addToCalendarBtn) {
                addToCalendarBtn.onclick = () => {
                    addToGoogleCalendar(data);
                };
            }

            // Add Back button functionality
            const backButton = document.getElementById('backButton');
            if (backButton) {
                backButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    location.reload();
                });
                // Ensure button is clickable
                backButton.style.pointerEvents = 'auto';
                backButton.style.zIndex = '1001';
                backButton.style.position = 'relative';
            }

            // Show modal
            modal.style.display = 'block';
        }

        function addToGoogleCalendar(reservationData) {
            // Create Google Calendar URL
            const startDate = new Date(reservationData.date + 'T' + reservationData.time);
            const endDate = new Date(startDate.getTime() + (2 * 60 * 60 * 1000)); // 2 hours later

            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const title = `XIX Restaurant - ${reservationData.eventType || 'Dinner'}`;
            const description = `Event: ${reservationData.eventType || 'N/A'}
Guests: ${reservationData.guests}
Menu: ${reservationData.menuPreference || 'N/A'}
Entertainment: ${reservationData.entertainment || 'N/A'}
Special Requests: ${reservationData.specialRequests || 'None'}`;

            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatDate(startDate)}/${formatDate(endDate)}&details=${encodeURIComponent(description)}&location=XIX Restaurant`;

            // Open Google Calendar in new tab
            window.open(googleCalendarUrl, '_blank');
        }

        // Cache for availability checks to reduce API calls
        const availabilityCache = {};
        const CACHE_DURATION = 60000; // 1 minute cache

        async function checkAvailableTimes(date, venue) {
            if (!date) return;

            // Clear cache to ensure fresh data (temporary fix for cache issues)
            // TODO: Remove this after confirming the fix works
            const cacheKey = `${date}-${venue}`;
            delete availabilityCache[cacheKey];

            console.log('Checking available times for:', date, venue);

            try {
                // Add timestamp to prevent browser caching
                const response = await fetch(`/api/available-times?date=${date}&venue=${venue}&_=${Date.now()}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    console.error('Availability check failed:', response.status);
                    return;
                }

                const data = await response.json();

                // Cache the result
                availabilityCache[cacheKey] = {
                    data: data,
                    timestamp: Date.now()
                };

                console.log('Available times response:', data);
                console.log('Total times received:', data.availableTimes?.length);

                updateTimeOptions(data);
            } catch (error) {
                console.error('Error checking available times:', error);
                // Don't show error to user, just log it
            }
        }

        function updateTimeOptions(data) {
            const timeSelect = document.getElementById('time');
            if (!timeSelect) {
                console.error('Time select element not found');
                return;
            }

            // Get selected date
            const dateInput = document.getElementById('date');
            const selectedDate = dateInput?.value;
            // Get today's date in local timezone (YYYY-MM-DD format)
            // Use toLocaleDateString('en-CA') which returns YYYY-MM-DD in local timezone
            const today = new Date().toLocaleDateString('en-CA');
            const isToday = selectedDate === today;

            // Get current time
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;

            // Clear existing options
            timeSelect.innerHTML = '';

            if (data.availableTimes.length === 0) {
                console.log('No available times');
                // No available times
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No available times for this date';
                option.disabled = true;
                timeSelect.appendChild(option);

                // Show message
                showNoAvailabilityMessage();
            } else {
                console.log('Available times:', data.availableTimes);
                // Add available times
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Time';
                timeSelect.appendChild(defaultOption);

                // Filter out past times if today is selected
                const filteredTimes = data.availableTimes.filter(time => {
                    if (!isToday) {
                        // For future dates, show all available times
                        return true;
                    }
                    // For today, filter out past times
                    const [h, m] = time.split(':');
                    let timeHour = parseInt(h, 10);
                    const timeMinute = parseInt(m, 10);

                    // Handle midnight times (00:00, 00:30, 01:00) - these are next day
                    // So if it's today and time is 00:00-01:00, it's actually tomorrow, so show it
                    if (timeHour === 0 || timeHour === 1) {
                        // These times are for the next day, so always show them
                        return true;
                    }

                    const timeInMinutes = timeHour * 60 + timeMinute;
                    // Only show times that are at least 30 minutes in the future
                    return timeInMinutes >= (currentTimeInMinutes + 30);
                });

                if (filteredTimes.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No available times for today';
                    option.disabled = true;
                    timeSelect.appendChild(option);
                    showNoAvailabilityMessage();
                } else {
                    filteredTimes.forEach(time => {
                        const option = document.createElement('option');
                        option.value = time;
                        // Format time nicely (e.g., "17:00" -> "5:00 PM")
                        const [h, m] = time.split(':');
                        const hour = parseInt(h, 10);
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const displayHour = hour % 12 || 12;
                        option.textContent = `${displayHour}:${m} ${ampm}`;
                        timeSelect.appendChild(option);
                    });

                    // Hide no availability message if it exists
                    hideNoAvailabilityMessage();
                }
            }
        }

        function showNoAvailabilityMessage() {
            // Remove existing message if any
            hideNoAvailabilityMessage();

            const message = document.createElement('div');
            message.id = 'no-availability-message';
            message.style.cssText = `
                background: #ffebee;
                color: #c62828;
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 8px;
                border: 1px solid #ffcdd2;
                text-align: center;
                font-weight: 500;
            `;
            message.textContent = 'Sorry, no available time slots for this date. Please choose another date.';

            const form = document.getElementById('reservationForm');
            if (form) {
                form.insertBefore(message, form.querySelector('.form-group'));
            }
        }

        function hideNoAvailabilityMessage() {
            const message = document.getElementById('no-availability-message');
            if (message) {
                message.remove();
            }
        }
    </script>

</body>

</html>